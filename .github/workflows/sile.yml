name: SILE

on: [ push, pull_request ]

jobs:

  sile:
    strategy:
      fail-fast: false
      matrix:
        # Test oldest compatible release plus newest patch of each minor bump since
        sileVersion: [ "v0.14.0", "v0.14.8" ]
    runs-on: ubuntu-latest
    container:
      image: docker://siletypesetter/sile:${{ matrix.sileVersion }}
      options: --entrypoint=bash
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Freshen runner image
      run: pacman -Sy && pacman --noconfirm --needed -S archlinux-keyring && pacman --noconfirm -Su --ignore icu --ignore openssl
    - name: Install dev dependencies
      run: pacman --noconfirm --needed -S luarocks make words zsh
    - name: Build and install locally
      run: make install
    - name: Run test template
      run: ./lua_modules/bin/fontproof -t test -o test.pdf
#   Disabled because luasocket is acting up on Lua 5.4.3 and producing false failures
#   https://github.com/diegonehab/luasocket/issues/331
#   - name: Run gutenberg template
#     run: ./lua_modules/bin/fontproof -t gutenberg -o gutenberg.pdf
    - name: Run unichar template
      run: ./lua_modules/bin/fontproof -t unichar -o unichar.pdf
    - name: Run full template
      run: ./lua_modules/bin/fontproof -t full -o full.pdf
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: fp-template-tests.zip
        path: '*.pdf'
